DROP TABLE IF EXISTS TruckGPSData;
CREATE TABLE TruckGPSData (   
    lat FLOAT,
    lon FLOAT,
	unitid VARCHAR(50),
	utc_ts DATETIME,
	speed FLOAT
);

BULK INSERT TruckGPSData	--(07.58 mins)
FROM 'C:\Users\SeniorProject\Documents\DCB Project\grid_data\grid_clean_data100m.csv'
WITH (
    FIELDTERMINATOR = ',', 
    ROWTERMINATOR = '0x0a',
    FIRSTROW = 2         -- ข้าม Header Row
);

-----------------------

DROP TABLE IF EXISTS IndustrialZones;
CREATE TABLE IndustrialZones (
    id INT IDENTITY PRIMARY KEY,
    name VARCHAR(100),
    province VARCHAR(100), -- เพิ่มจังหวัดเข้าไป
    geom GEOGRAPHY
);


---------------------


INSERT INTO IndustrialZones (name, province, geom)
VALUES 
('Laem Chabang Port', 'Chonburi', geography::STGeomFromText('POLYGON ((100.878403 13.071175, 100.8789198 13.07028, 100.878724 13.0701585, 100.8788643 13.0699198, 100.8790552 13.0700259, 100.8793956 13.0695264, 100.879193 13.0694088, 100.8793737 13.0691143, 100.8795681 13.0692236, 100.8803761 13.067872, 100.8800202 13.0676651, 100.8824587 13.0635129, 100.8828304 13.0637325, 100.8828606 13.0637031, 100.8834021 13.0640081, 100.8836202 13.0636593, 100.8868143 13.0655003, 100.8867152 13.0656629, 100.8857561 13.0651288, 100.8856471 13.0653248, 100.8868543 13.0659993, 100.8869482 13.0660549, 100.8870354 13.0660549, 100.8870824 13.0660255, 100.8871226 13.0659912, 100.8871494 13.0659993, 100.8872771 13.0657676, 100.8962538 13.0708683, 100.8956883 13.0718432, 100.8966058 13.0723606, 100.897163 13.0714246, 100.8973886 13.0715453, 100.8992353 13.0684089, 100.8845136 13.0599943, 100.8847766 13.0595636, 100.8850232 13.0597207, 100.8851466 13.0596698, 100.8856113 13.0590092, 100.8881878 13.0546536, 100.8890148 13.0519776, 100.9050537 13.0565878, 100.9064907 13.0518217, 100.9066494 13.0518716, 100.9066693 13.0517807, 100.9066233 13.0516943, 100.9065212 13.0516352, 100.9056584 13.0514079, 100.9054907 13.0520132, 100.890443 13.0476892, 100.8906057 13.04708, 100.8904788 13.047047, 100.8917369 13.0428865, 100.9151739 13.0495678, 100.912319 13.0592428, 100.9141223 13.0599013, 100.9130716 13.0630248, 100.9136504 13.0640535, 100.9122127 13.0685893, 100.9169334 13.0718918, 100.9169538 13.0725157, 100.9139497 13.0783054, 100.9191221 13.0803359, 100.9148091 13.0940037, 100.9146589 13.0951323, 100.9148436 13.0972011, 100.9151514 13.1006476, 100.914572 13.1016926, 100.9110959 13.1002087, 100.9096302 13.1030311, 100.911101 13.1037258, 100.9107977 13.1043562, 100.91049 13.1049957, 100.9048088 13.1021061, 100.9025305 13.1007969, 100.9019135 13.0999696, 100.9007172 13.0993581, 100.9007881 13.0992351, 100.9010501 13.0987288, 100.9010668 13.0986223, 100.8998543 13.098, 100.8994158 13.0986846, 100.896981 13.0974319, 100.8966077 13.0978064, 100.8947729 13.0969939, 100.8932871 13.096219, 100.8925994 13.0956527, 100.8919878 13.0949955, 100.8917778 13.0944687, 100.8916531 13.093984, 100.8916233 13.0931563, 100.8916554 13.0927083, 100.8917475 13.0923664, 100.8921069 13.0915166, 100.8915919 13.0912658, 100.890239 13.0934373, 100.8884806 13.0925407, 100.890047 13.089552, 100.8899826 13.0892385, 100.886804 13.0873737, 100.8841043 13.0857899, 100.8850508 13.0842344, 100.8864839 13.0818794, 100.8865075 13.0816108, 100.8847029 13.0805627, 100.8856702 13.0788298, 100.8850024 13.0781655, 100.8864485 13.0757821, 100.8862136 13.0755716, 100.8839267 13.0743081, 100.878403 13.071175))', 4326)),

('Bang Pa-in Industrial Estate', 'Ayutthaya', geography::STGeomFromText('POLYGON ((100.5792624 14.1865569, 100.5797215 14.1865045, 100.5802706 14.1868711, 100.5805767 14.1869583, 100.5818099 14.1874471, 100.5823285 14.186923, 100.5829091 14.1874793, 100.583783 14.186115, 100.5843475 14.1870883, 100.5846243 14.1867065, 100.5864674 14.1880854, 100.586692 14.187621, 100.5872394 14.1878679, 100.5868829 14.188556, 100.5873998 14.1891663, 100.58853 14.1901699, 100.5892502 14.1894849, 100.5911206 14.1910043, 100.5915789 14.1918189, 100.5903186 14.1927198, 100.5911715 14.1941391, 100.5918972 14.19388, 100.5922956 14.1948118, 100.5904409 14.1958635, 100.5915806 14.1979348, 100.5908605 14.1981836, 100.5910225 14.1985763, 100.5915806 14.1991042, 100.5917426 14.1996584, 100.5926628 14.1994157, 100.5936176 14.201958, 100.5924973 14.2025195, 100.5933948 14.2050618, 100.592049 14.2067004, 100.5855183 14.2127722, 100.5819792 14.2134263, 100.5792624 14.1865569))', 4326)),
('Hi-Tech Industrial Estate', 'Ayutthaya', geography::STGeomFromText('POLYGON ((100.5860704 14.2470553, 100.5866019 14.2462771, 100.588059 14.2466195, 100.588692 14.2467683, 100.588908 14.2467378, 100.5897674 14.2464555, 100.5909887 14.2468286, 100.5917593 14.2465751, 100.5927824 14.2464632, 100.5927814 14.2464192, 100.5928935 14.2464161, 100.5930468 14.2464118, 100.5930447 14.2460663, 100.5930331 14.2441424, 100.5930312 14.2438185, 100.5924363 14.2438029, 100.5924436 14.2422831, 100.5944297 14.2423482, 100.5995518 14.2421143, 100.5995655 14.2431311, 100.601259 14.2430776, 100.6012233 14.24121, 100.6002333 14.241245, 100.6001532 14.2405192, 100.603066 14.2404282, 100.60307 14.2402498, 100.6035665 14.2401788, 100.6035769 14.2403311, 100.6055671 14.2403152, 100.6057439 14.240314, 100.6057572 14.2414938, 100.607779 14.2414837, 100.6086899 14.2429484, 100.6099798 14.2425126, 100.6102438 14.2431304, 100.6091678 14.2437218, 100.6092918 14.2492145, 100.6125463 14.2491807, 100.6124477 14.2494965, 100.6118092 14.2500793, 100.6112495 14.2504734, 100.6106143 14.2507774, 100.6104646 14.2509222, 100.6103721 14.2511682, 100.6103761 14.2514037, 100.6105261 14.2517585, 100.6104996 14.2520154, 100.6104354 14.2522166, 100.6103069 14.2523451, 100.6096534 14.2529195, 100.6081898 14.2539306, 100.6074354 14.2554457, 100.6073028 14.2557608, 100.6070344 14.2561649, 100.6059616 14.2569132, 100.604556 14.2575092, 100.5997655 14.2576152, 100.5980408 14.2574732, 100.5961849 14.2574274, 100.5949351 14.2574501, 100.5926221 14.257492, 100.5925713 14.2545722, 100.5922297 14.2545621, 100.5920756 14.2533271, 100.5898569 14.2537229, 100.5898722 14.2576489, 100.5896029 14.2576789, 100.5876209 14.2589668, 100.5875291 14.2589236, 100.5874635 14.2588268, 100.5862883 14.2492249, 100.586115 14.2474998, 100.5860704 14.2470553))', 4326)),
('Bang Pa-in Industrial Estate', 'Ayutthaya', geography::STGeomFromText('POLYGON ((100.5835114 14.4941797, 100.584369 14.4917784, 100.5857298 14.4902851, 100.5867502 14.4875646, 100.5912313 14.4852735, 100.5917193 14.486147, 100.5936123 14.4855599, 100.5938933 14.4860468, 100.5937307 14.4869059, 100.5949434 14.4888246, 100.5965997 14.4881803, 100.5962892 14.4875502, 100.5982413 14.4868773, 100.5982413 14.487765, 100.5984484 14.488166, 100.5977533 14.488796, 100.5982561 14.4894546, 100.5975758 14.4898556, 100.5980493 14.4906612, 100.6006492 14.4912896, 100.6004678 14.4930278, 100.5998911 14.4930565, 100.599965 14.4927415, 100.5974805 14.4933428, 100.5950403 14.4907941, 100.5938719 14.491238, 100.593724 14.4908801, 100.5926001 14.4913812, 100.5924966 14.4912667, 100.5912543 14.4917964, 100.5911803 14.491596, 100.5894944 14.4920828, 100.5901451 14.4934431, 100.5913726 14.4931997, 100.5920825 14.4953331, 100.5911064 14.4955765, 100.5925853 14.4984115, 100.594567 14.4975524, 100.5945226 14.4972947, 100.5957206 14.4968938, 100.5957354 14.497037, 100.5953213 14.4972231, 100.5956614 14.4985117, 100.5952473 14.498569, 100.5959868 14.5000294, 100.595188 14.5016623, 100.589871 14.5103772, 100.5889095 14.5144547, 100.5858994 14.5135652, 100.5855289 14.5130301, 100.5852928 14.5126977, 100.5850353 14.5112228, 100.5865386 14.5092715, 100.5870406 14.5089589, 100.5875674 14.508865, 100.5879519 14.5087749, 100.587857 14.5071201, 100.5881985 14.5059103, 100.5893805 14.5066215, 100.5899599 14.5058425, 100.5896888 14.5051228, 100.5887583 14.5042948, 100.5902281 14.5016462, 100.5880095 14.4984323, 100.5873862 14.4985325, 100.5867354 14.4977736, 100.5864692 14.4968716, 100.5856854 14.4965852, 100.5852122 14.4956402, 100.5845615 14.495225, 100.584384 14.4948527, 100.5835114 14.4941797))', 4326)),

('Samut Sakhon Industrial Estate', 'Samut sakhon', geography::STGeomFromText('POLYGON ((100.2118684 13.5472133, 100.2118844 13.542907, 100.2123701 13.5433792, 100.2128931 13.5420534, 100.2125756 13.5416902, 100.2131599 13.5401968, 100.2150787 13.5402555, 100.215471 13.5425982, 100.2214299 13.5443417, 100.2212618 13.5449046, 100.2211684 13.5457763, 100.2213997 13.5469662, 100.2220837 13.546866, 100.2217671 13.5478163, 100.2222331 13.5478829, 100.2226067 13.5477013, 100.2232605 13.5477195, 100.223877 13.5479374, 100.2239704 13.548228, 100.224344 13.5484096, 100.2243066 13.548573, 100.2260999 13.5489544, 100.2263801 13.5491541, 100.2266728 13.5493682, 100.2286265 13.5497674, 100.2298723 13.5497949, 100.2296599 13.5490104, 100.2286265 13.5491205, 100.2277063 13.5485012, 100.2295608 13.5452807, 100.2299006 13.5450329, 100.2303111 13.5447301, 100.2308208 13.5449228, 100.231019 13.5447577, 100.231203 13.5443861, 100.2317834 13.5443723, 100.2320099 13.5447164, 100.232194 13.5453357, 100.2322506 13.5458312, 100.2327886 13.546134, 100.2331566 13.546423, 100.2331708 13.5470561, 100.233638 13.5472075, 100.2347988 13.5470974, 100.2355491 13.5485838, 100.2347281 13.549382, 100.2339494 13.549382, 100.2343175 13.5504693, 100.2337937 13.5504142, 100.2340061 13.5526438, 100.2340627 13.5529603, 100.2354925 13.553731, 100.2361579 13.5541439, 100.2362711 13.5553137, 100.2373924 13.5552935, 100.2377576 13.5560844, 100.2363561 13.5568688, 100.2361437 13.5567725, 100.2347281 13.557612, 100.2354217 13.5581763, 100.2348555 13.5594149, 100.234275 13.5591671, 100.2335106 13.561259, 100.2332557 13.5611764, 100.2322648 13.5638738, 100.2316843 13.5638325, 100.2306792 13.5639976, 100.2302828 13.5624288, 100.2289096 13.5625664, 100.2284 13.5612865, 100.2249032 13.5617957, 100.2247475 13.5608461, 100.2267153 13.5604745, 100.2265454 13.5592222, 100.2284 13.5589882, 100.2281735 13.5583827, 100.2264746 13.5585478, 100.2263472 13.5571716, 100.2249032 13.5572817, 100.223589 13.5567899, 100.2237238 13.5528632, 100.222408 13.5524988, 100.2222668 13.5511514, 100.2228362 13.5508041, 100.2209013 13.5507442, 100.220666 13.5506136, 100.2209999 13.5501451, 100.2207657 13.5500733, 100.2205932 13.5490549, 100.2200632 13.548971, 100.2185474 13.548971, 100.2186706 13.5509599, 100.2181283 13.5509838, 100.2181037 13.5520262, 100.2161688 13.5518105, 100.2160332 13.5500014, 100.2158976 13.5492226, 100.2158956 13.5489729, 100.2142941 13.5488454, 100.2144381 13.5474548, 100.2118684 13.5472133))', 4326)),
('Sinsakhon Industrial Estate', 'Samut sakhon', geography::STGeomFromText('POLYGON ((100.3329634 13.5502752, 100.333256 13.5490052, 100.33846 13.5487629, 100.338684 13.5475585, 100.3391378 13.5447289, 100.3404843 13.5421579, 100.3414276 13.542336, 100.3412931 13.5417079, 100.3411715 13.5414496, 100.3420642 13.5406857, 100.3422399 13.540159, 100.3412668 13.5361277, 100.3460352 13.5361462, 100.345289 13.5378092, 100.345787 13.5380429, 100.3456781 13.5397854, 100.3473562 13.5396389, 100.3475051 13.5413547, 100.3465596 13.5412216, 100.345779 13.5415894, 100.3455774 13.5427848, 100.345711 13.5432483, 100.3455584 13.5438973, 100.3455011 13.5450656, 100.3449529 13.5448853, 100.3449862 13.5468271, 100.3448135 13.5470496, 100.3444272 13.5470809, 100.3447652 13.5474773, 100.3447759 13.548609, 100.3447382 13.5488483, 100.3483352 13.548695, 100.3483431 13.5490893, 100.3480188 13.5491821, 100.3477709 13.5499238, 100.3469889 13.5506655, 100.345711 13.5501834, 100.3450625 13.5507767, 100.3452723 13.5509621, 100.3444514 13.551592, 100.3451006 13.554856, 100.3435971 13.5551846, 100.3438681 13.5559369, 100.344427 13.5573441, 100.3446005 13.5604367, 100.3448295 13.5604262, 100.3458466 13.5603242, 100.345801 13.5598721, 100.3468997 13.5594285, 100.3482668 13.5587691, 100.3481742 13.5614692, 100.3469485 13.562516, 100.3467633 13.5634609, 100.3462391 13.5637793, 100.3456501 13.5631952, 100.3455605 13.5625219, 100.3445587 13.5625773, 100.3448792 13.5646554, 100.3447129 13.5653203, 100.3445573 13.5654572, 100.3442167 13.5654376, 100.3439739 13.5656345, 100.3435043 13.5656826, 100.3433758 13.5659395, 100.3428984 13.5659799, 100.3423539 13.5658613, 100.3420145 13.5659033, 100.3414311 13.5656568, 100.3405646 13.5660112, 100.3403103 13.5660419, 100.3395718 13.5673652, 100.3393214 13.5672046, 100.3386728 13.5669082, 100.3384821 13.5657586, 100.3355866 13.5646973, 100.335667 13.5630335, 100.3371116 13.5621773, 100.3378719 13.5610807, 100.3389604 13.5610848, 100.3392461 13.560669, 100.3392126 13.5563444, 100.3380703 13.5558581, 100.3369095 13.5552336, 100.3364574 13.5542271, 100.3359072 13.5550415, 100.334731 13.5550782, 100.3346046 13.554506, 100.3346102 13.5535581, 100.3333282 13.5527419, 100.3333067 13.5514799, 100.3333362 13.551094, 100.3330331 13.550815, 100.3329902 13.5506689, 100.3329634 13.5502752))', 4326)),

('Wellgrow Industrial Estate', 'Chachoengsao', geography::STGeomFromText('POLYGON ((100.9197106 13.5768243, 100.9197645 13.5764105, 100.9198123 13.5763863, 100.9198322 13.5762603, 100.9201014 13.5762475, 100.920197 13.5764502, 100.9206629 13.5761586, 100.9212745 13.5751148, 100.9216822 13.5750274, 100.9217235 13.5747983, 100.9216216 13.5742893, 100.9211496 13.5743509, 100.9208714 13.5734531, 100.9206519 13.5724946, 100.9205222 13.5707773, 100.9204908 13.5705247, 100.9245297 13.5697231, 100.9245684 13.5709442, 100.9275834 13.569245, 100.9291639 13.5689237, 100.9290965 13.5691659, 100.9285997 13.5700731, 100.9281486 13.5726883, 100.9283441 13.5733875, 100.9288711 13.5741812, 100.9292552 13.5749443, 100.9293592 13.575702, 100.929245 13.5764818, 100.9291315 13.5773304, 100.9293878 13.5774353, 100.9335959 13.5762649, 100.9362199 13.5754959, 100.9375743 13.5751467, 100.9377533 13.5758253, 100.9425553 13.574242, 100.942878 13.57523, 100.9430114 13.5760104, 100.9430102 13.5770898, 100.9429099 13.5786103, 100.9437659 13.5783501, 100.9443908 13.5784674, 100.9448667 13.5784537, 100.945848 13.57785, 100.9462012 13.5777407, 100.9469238 13.5776764, 100.9473246 13.5778444, 100.9477834 13.5782279, 100.9480892 13.5788001, 100.948126 13.5793234, 100.9480436 13.5799153, 100.950603 13.5800847, 100.9509056 13.5824162, 100.9513948 13.5860359, 100.9515597 13.5863891, 100.9517971 13.5879605, 100.9526932 13.5938929, 100.9528434 13.5951547, 100.9529048 13.5960496, 100.9529185 13.5962497, 100.9532216 13.5984839, 100.9532404 13.5987654, 100.9530929 13.5990757, 100.9519288 13.5997874, 100.9514638 13.5985648, 100.9502658 13.599266, 100.9497267 13.5979208, 100.9495899 13.5979494, 100.9494657 13.5975757, 100.9442225 13.5992077, 100.936107 13.5884181, 100.9360903 13.5879226, 100.9355836 13.5876146, 100.9319714 13.5859353, 100.9328046 13.5858473, 100.9331498 13.5849255, 100.9327832 13.5848071, 100.932762 13.5847347, 100.930879 13.5849725, 100.9309863 13.5855335, 100.9267645 13.5862776, 100.9268635 13.583639, 100.9268314 13.5827682, 100.9268568 13.5825581, 100.9269427 13.5818491, 100.9232439 13.5825316, 100.9226257 13.5826874, 100.9225827 13.582544, 100.9220222 13.5826718, 100.9219471 13.5824945, 100.9221858 13.5822416, 100.9218156 13.5818531, 100.9223145 13.5815481, 100.9221187 13.5811987, 100.9221181 13.5810618, 100.9228581 13.5804893, 100.9228905 13.5804643, 100.9208631 13.5783715, 100.9202108 13.5783241, 100.9197586 13.577167, 100.9197106 13.5768243))', 4326)),
('Gateway City Industrial Estate', 'Chachoengsao', geography::STGeomFromText('POLYGON ((101.3229004 13.6142224, 101.3260761 13.6115529, 101.3256684 13.6108647, 101.3266984 13.6101348, 101.3242308 13.6071942, 101.3288227 13.6034819, 101.3338867 13.5989979, 101.333994 13.5984765, 101.3333074 13.5977882, 101.3344875 13.5967037, 101.3343803 13.5960989, 101.3318268 13.5933458, 101.3330713 13.5915521, 101.3377515 13.587707, 101.3440791 13.5949309, 101.3469759 13.5985182, 101.3517395 13.5948683, 101.3584128 13.6030022, 101.363391 13.6086332, 101.3559238 13.6137218, 101.3505164 13.6182264, 101.3446876 13.6114506, 101.3349811 13.6193109, 101.3310972 13.6226058, 101.3289328 13.6220568, 101.328371 13.6218673, 101.3259331 13.6203583, 101.3240827 13.6196757, 101.3242261 13.6184005, 101.3243414 13.6178912, 101.3245773 13.6173944, 101.3248369 13.6170478, 101.3247458 13.6168292, 101.3229004 13.6142224))', 4326)),
('TFD Industrial Estate', 'Chachoengsao', geography::STGeomFromText('POLYGON ((100.9857166 13.5673983, 100.9859378 13.5671, 100.9865905 13.5675491, 100.9880018 13.5652681, 100.9889117 13.5638237, 100.9888145 13.563724, 100.989528 13.5629397, 100.9902468 13.5622905, 100.9919903 13.5602489, 100.9924328 13.5597326, 100.9927024 13.559537, 100.9929237 13.5594327, 100.9931946 13.5593636, 100.9935272 13.5593506, 100.9938209 13.5594379, 100.9940556 13.5595696, 100.9943318 13.5597899, 100.9964213 13.5630571, 100.9968397 13.563589, 100.9971455 13.5641417, 100.9967378 13.5646919, 100.9962523 13.5651169, 100.9950104 13.566066, 100.9939322 13.5671533, 100.9938127 13.5672677, 100.9925455 13.5684804, 100.992296 13.569041, 100.9922677 13.5691095, 100.9921056 13.5695025, 100.9914297 13.5707527, 100.9910059 13.5717761, 100.9907055 13.5716066, 100.9884766 13.5701152, 100.9862691 13.5684674, 100.9865802 13.5679563, 100.9857166 13.5673983))', 4326)),
('TFD Industrial Estate 2', 'Chachoengsao', geography::STGeomFromText('POLYGON ((100.9706023 13.5868463, 100.9706419 13.5868223, 100.9714489 13.5853479, 100.9719569 13.5838953, 100.972211 13.583583, 100.9724638 13.5836951, 100.9746364 13.5811818, 100.9753002 13.5808963, 100.977419 13.5796319, 100.9783455 13.5792615, 100.9782708 13.5789565, 100.9776506 13.5770317, 100.979272 13.5751215, 100.9804227 13.5749908, 100.9805348 13.5749908, 100.9805348 13.5764144, 100.9810354 13.5764434, 100.9816332 13.5749254, 100.9819246 13.5740974, 100.9824317 13.572336, 100.9824327 13.5722598, 100.9819321 13.5721508, 100.9818798 13.5720273, 100.9828436 13.5709233, 100.9834414 13.5702478, 100.984495 13.5689695, 100.9853679 13.5698545, 100.9869084 13.5701025, 100.9872222 13.5692309, 100.9911668 13.5718893, 100.9910904 13.5728, 100.9909762 13.5732205, 100.990845 13.5735151, 100.9905794 13.573755, 100.9900739 13.5740344, 100.9878167 13.5751812, 100.9870523 13.5756818, 100.9866245 13.5760294, 100.9864825 13.5761311, 100.9857749 13.5766096, 100.9848368 13.5772853, 100.9838225 13.5778089, 100.9830102 13.5781326, 100.9827988 13.5780849, 100.9824082 13.5779713, 100.9821487 13.5779396, 100.9819561 13.5780886, 100.9817527 13.5779905, 100.9814763 13.5777145, 100.9809159 13.5779542, 100.9808967 13.5784272, 100.980269 13.5789135, 100.9800866 13.5791924, 100.9794663 13.5790872, 100.9792123 13.5796755, 100.980016 13.5799949, 100.9801164 13.5808521, 100.9803779 13.5817382, 100.9806418 13.5821034, 100.9801108 13.5831932, 100.979853 13.5834641, 100.9789628 13.5839754, 100.9783137 13.5844655, 100.9779495 13.5848541, 100.9777075 13.585378, 100.9766652 13.5865234, 100.9756739 13.5878495, 100.9748104 13.5887439, 100.9743385 13.5895311, 100.9743231 13.5896909, 100.9741014 13.5895822, 100.9716058 13.588609, 100.970612 13.5881877, 100.9706566 13.5878745, 100.9707233 13.5875042, 100.9706023 13.5868463))', 4326))

select * from IndustrialZones

--------------------------------
--solution_2: 1.33.31 mins, approx. 40 mins 

WITH results_unitid AS (
    SELECT DISTINCT g.unitid, z1.name + ' - Laem Chabang Port' AS OD
    FROM TruckGPSData g
    JOIN IndustrialZones z1
    ON geography::Point(g.lat, g.lon, 4326).STIntersects(z1.geom) = 1
    AND z1.province IN ('Ayutthaya', 'Samut Sakhon', 'Chachoengsao')
    WHERE EXISTS (
        SELECT 1 FROM TruckGPSData g2
        JOIN IndustrialZones z2
        ON geography::Point(g2.lat, g2.lon, 4326).STIntersects(z2.geom) = 1
        AND z2.name = 'Laem Chabang Port'
        WHERE g2.unitid = g.unitid
    )
)
--SELECT * FROM results_unitid;

SELECT g.unitid as unitid,
	utc_ts DATETIME,
	g.lat as lat,
	g.lon as lon,
	r.OD as OD
FROM TruckGPSData g  
INNER JOIN results_unitid r 
ON g.unitid = r.unitid
ORDER BY unitid,utc_ts;



-------------------------------------------------------------------------------
--กรองเส้นทางที่ไม่ใช่ OD ออก (2.15 mins) --ไม่ใช้แล้ว**

--DROP table if EXISTS TruckGPSData2;

CREATE TABLE TruckGPSData2 (
	unitid VARCHAR(50),  
    utc_ts DATETIME,  
    lat FLOAT,
    lon FLOAT,
	OD VARCHAR(50)
);

BULK INSERT TruckGPSData2	--(07.58 mins)
FROM 'C:\Users\SeniorProject\Documents\DCB Project\After SQL OD data\result_grid_clean_data100m(ก่อนกรอง noise ออก).csv'
WITH (
    FIELDTERMINATOR = ',', 
    ROWTERMINATOR = '\n'
);


-- STEP 1: หาเวลาที่รถเข้า Laem Chabang และเข้านิคม
WITH zone_visits AS (
    SELECT 
        g.unitid,
        g.utc_ts,
        z.name AS zone_name,
        z.province,
        geography::Point(g.lat, g.lon, 4326) AS geo_point
    FROM TruckGPSData2 g
    JOIN IndustrialZones z
        ON geography::Point(g.lat, g.lon, 4326).STIntersects(z.geom) = 1
    WHERE z.province IN ('Ayutthaya', 'Samut Sakhon', 'Chachoengsao')
       OR z.name = 'Laem Chabang Port'
),
-- STEP 2: หาคู่เวลาที่ unitid เข้าเขตนิคม และ เข้า Laem Chabang
entry_pairs AS (
    SELECT
        laem.unitid,
        MAX(laem.utc_ts) AS laem_ts,
        MAX(nikhom.utc_ts) AS nikhom_ts,
        nikhom.zone_name AS nikhom_name
    FROM zone_visits laem
    JOIN zone_visits nikhom
        ON laem.unitid = nikhom.unitid
       AND laem.zone_name = 'Laem Chabang Port'
       AND nikhom.zone_name != 'Laem Chabang Port'
       AND nikhom.utc_ts > laem.utc_ts
    GROUP BY laem.unitid, nikhom.zone_name
),
-- STEP 3: ดึง GPS log ระหว่างเวลาเดินทาง Laem -> Nikhom
filtered_trips AS (
    SELECT 
        g.unitid,
        g.utc_ts,
        g.lat,
        g.lon,
        e.nikhom_name + ' - Laem Chabang Port' AS OD
    FROM TruckGPSData2 g
    JOIN entry_pairs e 
        ON g.unitid = e.unitid
       AND g.utc_ts BETWEEN e.laem_ts AND e.nikhom_ts
)

-- STEP 4: แสดงผล
SELECT * 
FROM filtered_trips
ORDER BY unitid, utc_ts;


-------------------------------------------------------
---กรอง noise + รวมรถไป-กลับ (52,655 results) (5.19 mins)

WITH zone_visits AS (
    SELECT 
        g.unitid,
        g.utc_ts,
        z.name AS zone_name,
        z.province,
        geography::Point(g.lat, g.lon, 4326) AS geo_point
    FROM TruckGPSData2 g
    JOIN IndustrialZones z
        ON geography::Point(g.lat, g.lon, 4326).STIntersects(z.geom) = 1
    WHERE z.province IN ('Ayutthaya', 'Samut Sakhon', 'Chachoengsao')
       OR z.name = 'Laem Chabang Port'
),

-- แหลมฉบัง → นิคม
entry_outbound AS (
    SELECT
        laem.unitid,
        MAX(laem.utc_ts) AS start_time,
        MAX(nikhom.utc_ts) AS end_time,
        'Laem Chabang Port - ' + nikhom.zone_name AS OD
    FROM zone_visits laem
    JOIN zone_visits nikhom
        ON laem.unitid = nikhom.unitid
       AND laem.zone_name = 'Laem Chabang Port'
       AND nikhom.zone_name != 'Laem Chabang Port'
       AND nikhom.utc_ts > laem.utc_ts
    GROUP BY laem.unitid, nikhom.zone_name
),

-- นิคม → แหลมฉบัง
entry_inbound AS (
    SELECT
        nikhom.unitid,
        MAX(nikhom.utc_ts) AS start_time,
        MAX(laem.utc_ts) AS end_time,
		nikhom.zone_name + ' - Laem Chabang Port' AS OD
    FROM zone_visits nikhom
    JOIN zone_visits laem
        ON nikhom.unitid = laem.unitid
       AND nikhom.zone_name != 'Laem Chabang Port'
       AND laem.zone_name = 'Laem Chabang Port'
       AND laem.utc_ts > nikhom.utc_ts
    GROUP BY nikhom.unitid, nikhom.zone_name
),

-- รวมทั้งขาไปขากลับ
entry_pairs AS (
    SELECT * FROM entry_outbound
    UNION ALL
    SELECT * FROM entry_inbound
),

-- ดึง GPS log ตามช่วงเวลา
filtered_trips AS (
    SELECT 
        g.unitid,
        g.utc_ts,
        g.lat,
        g.lon,
        e.OD
    FROM TruckGPSData2 g
    JOIN entry_pairs e 
        ON g.unitid = e.unitid
       AND g.utc_ts BETWEEN e.start_time AND e.end_time
)

-- ผลลัพธ์สุดท้าย
SELECT * 
FROM filtered_trips
ORDER BY unitid, utc_ts;
